% !TeX spellcheck = <none>

%\newcommand{\compileall}{def}


\documentclass[amstex,twoside]{ctexbook}


\usepackage{marginnote}

% 16开本
\usepackage[
		paperwidth=195mm,
		paperheight=271mm,
		%装订线宽10mm,页边距 28mm
		inner = 38mm,
		outer = 28mm,
		tmargin = 36mm,
		bmargin = 30mm,
		marginparwidth=2cm
	]{geometry}

\usepackage{needspace}
\usepackage{wrapfig}
\usepackage{float}
\usepackage[below,section]{placeins}
\usepackage{color}
\usepackage{tabularx}
\usepackage{longtable}
\usepackage{multirow}
\usepackage{rotating}
\usepackage{soul}
\usepackage{amsmath}
\usepackage{wasysym}
\usepackage{amsthm}
\usepackage{stmaryrd}
\usepackage{xltxtra}
% always load hyperref as last packages
\usepackage[colorlinks,linkcolor=black]{hyperref}
%\usepackage{todonotes}


%\input{draftcopy}

%=====================================================================================
% font setting
%=====================================================================================
\input{setfonts}

%=====================================================================================
% define new command and environment 
%=====================================================================================
\renewcommand*{\marginfont}{\color{red}\scriptsize}
\newcommand*{\todo}[1]{\marginnote[%
\color{blue}\footnotesize%
TODO:#1%
]{%
\color{blue}\footnotesize%
TODO:#1}
}

\definecolor{gray}{cmyk}{0,0,0,0.2}

%=====================================================================================
% define new command and environment 
%=====================================================================================
\newenvironment{notice}{\tt}{}
\newenvironment{insertnote}{ \ttfamily\CJKfamily{KaiTi} }{\vskip 0.5cm }
\newenvironment{code}{\small\tt\begin{longtable}{p{0.8\textwidth}}}{\end{longtable}}

\newcommand{\email}[1]{\href{mailto:#1}{#1}}

\newcommand{\RTLpar}{% right-to-left paragraph alignment
  \leftskip=0pt plus .5fil%
  \rightskip=0pt plus -.5fil%
  \parfillskip=0pt plus .5fil%
}

\newenvironment{quotes}[2][0.55]{\pushQED{#2}%
\begin{flushright}%
\begin{minipage}{#1\textwidth}\begin{flushright}\noindent\it\RTLpar}{%
 \\------\popQED{}\end{flushright}\end{minipage}\end{flushright}\vskip 8mm }%

\newenvironment{filecontent}[1]{

\addtolength{\linewidth}{-\parindent}
\begin{minipage}{\linewidth}

\vskip 1ex

文件: #1

\vskip -2ex
\rule{\textwidth}{0.02pt}
\vskip -1ex

%\hline

}{	\end{minipage}}




\newcounter{lizi}[chapter]

\newenvironment{example}[1]{ \addtocounter{lizi}{1} \vskip 2.5ex \bf 例\hskip -0.05em\arabic{chapter}.\arabic{lizi}： #1%
\par %
 \tt\small\CJKfamily{zhfs}}{ \vskip 2.5ex  }

\newcommand{\theexample}{\arabic{chapter}.\arabic{lizi}}

\makeatletter\newcommand{\chatu}{\@ifstar%
                     \chatuStar%
                     \chatuNoStar%
}\makeatother

\newcommand{\chatuNoStar}[3][scale=0.35]{%
\begin{figure}[htbp]%
\noindent\centering%
\includegraphics[#1]{pics/#2}%
\caption{#3\label{fig:#2}}%
\end{figure}%
}


\newcommand{\chatuStar}[3][scale=0.35]{%
\begin{figure*}[H]%
\noindent\centering%
\includegraphics[#1]{pics/#2}%
\label{fig:#2}%
\end{figure*}%
}


\newcommand{\faqref}[1]{~附录 \ref{chap:FAQ}.\nameref{chap:FAQ}~“\nameref{#1}”}
\newcommand{\secref}[1]{ { \it节\ref{#1}~\nameref{#1}} }

\newcommand{\chapref}[1]{ { \it第\ref{#1}章~\nameref{#1}} }


\newcounter{faqs}

\makeatletter
\newcommand\@publisher{}
\newcommand{\publisher}[1]{
\renewcommand\@publisher{#1}
}

\newcommand\@company{}
\newcommand{\company}[1]{
\renewcommand\@company{#1}
}
\makeatother


%=====================================================================================
% style settings
%=====================================================================================

% 阿拉伯数字章节
\setcounter{chapter}{-1}
\CTEXsetup[number={\arabic{chapter}}]{chapter}
% 对齐设置
\tolerance=4500
\punctstyle{hangmobanjiao}
\CJKecglue{}
\CJKsetecglue{} %{\hskip 0.1em plus 0.05em minus 0.05em}

%=====================================================================================
% book info
\input{bookinfo}
%=====================================================================================


\begin{document}

%=========================================================
% 首页
%=========================================================
{

\include{coverpage}
\include{thanks}
}

%=========================================================
%目录
%=========================================================
\tableofcontents

%=========================================================
% 序言
%=========================================================
\ifdefined\compileall
	\include{preface}
\else
	\addtocounter{chapter}{1}
\fi


%=========================================================
% 正文开始
%=========================================================

\ifdefined\compileall
\include{chp_unix}
\else
\addtocounter{chapter}{1}
\fi 

\ifdefined\compileall
\include{chp_hackerandlinux}
\else
\addtocounter{chapter}{1}
\fi

\ifdefined\compileall
\include{linuxintro}
\else
\addtocounter{chapter}{1}
\fi

\ifdefined\compileall
\include{install}
\else
\addtocounter{chapter}{1}
\fi

\ifdefined\compileall
\include{dialy}
\else
\addtocounter{chapter}{1}
\fi

\chapter{软件管理}\label{软件管理}


\section{软件的分发}
\section{软件的编译}
\section{发行版的包管理}\label{section:pkgmgr}
\section{portage和emerge}\label{sec:emerge}

\section{什么是overlay，如何使用}\label{sec:overlay}

/usr/portage下存放了数万个ebuild文件，这些文件按照预定的格式组织，形成了Gentoo的软件仓库，又称portage树。
使用命令{\tt emerge --sync}可以方便的将本地的portage树与Gentoo官方发布的portage树进行增量同步。

portage里虽然有数万个\footnote{截至到本书写作的时候有32225个ebuild共计15731个软件。}ebuild，但是总有软件是游离在portage之外的。
总要有机制可以添加第三方仓库吧？这样有的特殊软件可以放到第三方仓库中，想要使用的人添加第三方仓库即可使用emerge安装这些软件。
用户还可以自己维护一个给自己用的仓库，编写自己用的ebuild，这样就有可以更强大的定制能力了。
Gentoo使用overlay来支持这种需求。

所谓overlay就是结构和portage一样的一个目录，该目录里存放的ebuild也会被emerge使用。如果overlay里的版本和portage里的一样高，则overlay里的ebuild有更高的优先级。
overlay通常包含portage没有的软件，或者相同版本但是打上不同的补丁以提供增强功能。只要在 make.conf 中设定 PORTDIR\_OVERLAY 为一个overlay的路径即可使用该overlay。
overlay可以有多个，亦即PORTDIR\_OVERLAY可以设定多个路径，以空白隔开（通常是每行写一个overlay，参考 /var/lib/layman/make.conf），相互之间的优先级看它在PORTDIR\_OVERLAY变量中出现的次序。后出现的优先级高。

\subsection{用layman管理overlay}

现成的overlay被gentoo官方收录到了一个xml文件中：

\url{http://www.gentoo.org/proj/en/overlays/repositories.xml}

使用layman(8)工具即可自动获取这些overlay。这些overlay使用版本控制工具\footnote{参考 \chapref{chap:VCS}}，用户也使用版本控制工具获得这些overlay。
所以layman依赖一些版本控制工具，可以用USE控制layman依赖的版本控制工具。

\begin{code}
\#USE="git subversion" emerge layman
\end{code}

这样会将 git 和 subversion （大部分overlay使用git和svn）作为 layman 的依赖而被自动安装（如果还没安装的话）。没有安装的版本控制工具将无法添加使用该工具管理的overlay。

在 make.conf\footnote{ /etc/portage/make.conf 别忘记哦！} 里最后加入一行 “{\tt source /var/lib/layman/make.conf}”（不包括引号）， 然后就可以使用 layman -a overlay名字 添加指定名字的overlay了。

\begin{insertnote}
注意：/var/lib/layman/make.conf只有在添加了第一个overlay后才会生成。所以可以在添加一个overlay后再加入对该文件的source操作。
\end{insertnote}

\begin{example}{添加 gentoo-zh overlay。}
\begin{code}
\#layman -f \\
\#layman -a gentoo-zh
\end{code}

第一次使用layman需要layman -f，这一步到gentoo.org下载repositories.xml文件。如果已经下载过可以跳过这条命令。

\end{example}

\subsubsection*{列出所有的overlay}

\begin{code}
\#layman -L
\end{code}

\subsubsection*{列出已经添加的overlay}

\begin{code}
\#layman -l
\end{code}

\subsubsection*{添加一个overlay}

\begin{code}
\#layman -a <overlay名字>
\end{code}

\subsubsection*{删除一个overlay}

\begin{code}
\#layman -d <overlay名字>
\end{code}

\subsubsection*{更新一个overlay}

\begin{code}
\#layman -s <overlay名字>
\end{code}

\subsubsection*{一次性升级所有overlay}

\begin{code}
\#layman -S
\end{code}


% \include{gui}
\include{network}


\chapter{文件系统}

\begin{quotes}{Ken Thompson}
We have persistant objects, they're called files.
\end{quotes}

\section{磁盘上的文件系统	}
\subsection{块设备和磁盘}
\subsection{超级块和inode}
\subsection{典型磁盘文件系统举例}
\section{虚拟文件系统}
\subsection{/proc内核信息窗口}
\subsection{/dev设备文件系统和udev}
\subsection{虚拟内存盘tmpfs}
\section{网络文件系统	}
\subsection{NFS}
\subsection{Windows 网络邻居 CIFS}
\section{  其他的文件系统	}
\subsection{  LiveCD的最爱——压缩文件系统squashfs}
\subsection{  为Flash芯片设计的文件系统}

\chapter{架设服务器}
\section{  搭建 HTTP 服务器}
\subsection{  apache 用的最多的服务器}
\subsection{ nginx 轻量级服务器}
\subsection{ lighttpd 超轻量级服务器}
\subsection{ squid 加速代理	}
\section{  数据库	}
\subsection{  最流行的开源数据库 MySQL}
\subsection{  最优秀的开源数据库 PostgreSQL 	}
\subsection{  商业霸主 OracleDB	}
\section{  加速 DNS ，在本机搭建 DNS	}
\section{  共享打印机	}
\subsection{ CUPS 打印服务	}
\subsection{ Samba 打印机共享	}

\ifdefined\compileall
\include{optimize}
\else
\addtocounter{chapter}{1}
\fi


\chapter{时光机器-版本控制系统}\label{chap:VCS}
\section{   历史和后悔药	}
\section{   中心式版本控制仓库 CVS	}
\section{   CVS 后继 SVN	}
\section{GIT 划时代的分布式版本控制\label{sec:git}}
\subsection{  Bitkeeper	}
\subsection{  Linus 消失的一周	}
\subsection{  版本控制设计为一个文件系统	}
\subsection{ 去中心化	}
\subsection{  GIT典型工作流	}
\subsection{  GIT 简单使用	}


\appendix

{ \include{faq} }

%{ \include{wars} }

{ \include{manpage} }


\chapter{名称缩写}

\chapter{图片索引}
%\cleardoublepage
{
\renewcommand{\cleardoublepage}{}

\renewcommand\listfigurename{}
\vskip -3cm
%\addtocounter{chapter}{1}
%\addcontentsline{toc}{chapter}{图片索引}
\listoffigures 
%\cleardoublepage
}


\ifdefined\compileall
\include{app_gentoolife}
\else
\addtocounter{chapter}{1}
\fi

\end{document}
